<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: modules/sql.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: modules/sql.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

var async = require('async');
var extend = require('extend');
var jsonSql = require('json-sql')();
jsonSql.setDialect('postgresql');
var sandboxHelper = require('../helpers/sandbox.js');

// Private fields
var modules, library, self, __private = {}, shared = {};

__private.loaded = false;
__private.SINGLE_QUOTES = /'/g;
__private.SINGLE_QUOTES_DOUBLED = '\'\'';
__private.DOUBLE_QUOTES = /"/g;
__private.DOUBLE_QUOTES_DOUBLED = '""';

/**
 * Initializes library with scope content.
 * @class
 * @classdesc Main Sql methods.
 * @param {setImmediateCallback} cb - Callback function.
 * @param {scope} scope - App instance.
 */
// Constructor
function Sql (cb, scope) {
	library = scope;
	self = this;

	setImmediate(cb, null, self);
}

// Private methods
/**
 * Adds scape values based on input type.
 * @private
 * @param {*} what
 * @return {string} 
 * @throws {string} Unsupported data (with type)
 */
__private.escape = function (what) {
	switch (typeof what) {
	case 'string':
		return '\'' + what.replace(
				__private.SINGLE_QUOTES, __private.SINGLE_QUOTES_DOUBLED
			) + '\'';
	case 'object':
		if (what == null) {
			return 'null';
		} else if (Buffer.isBuffer(what)) {
			return 'X\'' + what.toString('hex') + '\'';
		} else {
			return ('\'' + JSON.stringify(what).replace(
					__private.SINGLE_QUOTES, __private.SINGLE_QUOTES_DOUBLED
				) + '\'');
		}
		break;
	case 'boolean':
		return what ? '1' : '0'; // 1 => true, 0 => false
	case 'number':
		if (isFinite(what)) { return '' + what; }
	}
	throw 'Unsupported data ' + typeof what;
};

/**
 * Adds double quotes to input string.
 * @private
 * @param {string} str
 * @return {string} 
 */
__private.escape2 = function (str) {
	return '"' + str.replace(__private.DOUBLE_QUOTES, __private.DOUBLE_QUOTES_DOUBLED) + '"';
};

/**
 * @private
 * @param {Object} obj
 * @param {string} dappid
 */
__private.pass = function (obj, dappid) {
	for (var property in obj) {
		if (typeof obj[property] === 'object') {
			__private.pass(obj[property], dappid);
		}
		if (property === 'table') {
			obj[property] = 'dapp_' + dappid + '_' + obj[property];
		}
		if (property === 'join' &amp;&amp; obj[property].length === undefined) {
			for (var table in obj[property]) {
				var tmp = obj[property][table];
				delete obj[property][table];
				obj[property]['dapp_' + dappid + '_' + table] = tmp;
			}
		}
		if (property === 'on' &amp;&amp; !obj.alias) {
			for (var firstTable in obj[property]) {
				var secondTable = obj[property][firstTable];
				delete obj[property][firstTable];

				var firstTableRaw = firstTable.split('.');
				firstTable = 'dapp_' + dappid + '_' + firstTableRaw[0];

				var secondTableRaw = secondTable.split('.');
				secondTable = 'dapp_' + dappid + '_' + secondTableRaw[0];

				obj[property][firstTable] = secondTable;
			}
		}
	}
};

/**
 * Creates sql query to dapps
 * @implements {jsonSql.build}
 * @implements {library.db.query}
 * @implements {async.until}
 * @param {string} action
 * @param {Object} config
 * @param {function} cb
 * @return {setImmediateCallback} cb, err, data
 */
__private.query = function (action, config, cb) {
	var sql = null;

	function done (err, data) {
		if (err) {
			err = err;
		}

		return setImmediate(cb, err, data);
	}

	if (action !== 'batch') {
		__private.pass(config, config.dappid);

		var defaultConfig = {
			type: action
		};

		try {
			sql = jsonSql.build(extend({}, config, defaultConfig));
			library.logger.trace('sql.query:', sql);
		} catch (e) {
			return done(e);
		}

		// console.log(sql.query, sql.values);

		library.db.query(sql.query, sql.values).then(function (rows) {
			return done(null, rows);
		}).catch(function (err) {
			library.logger.error(err.stack);
			return done('Sql#query error');
		});
	} else {
		var batchPack = [];
		async.until(
			function () {
				batchPack = config.values.splice(0, 10);
				return batchPack.length === 0;
			}, function (cb) {
			var fields = Object.keys(config.fields).map(function (field) {
				return __private.escape2(config.fields[field]);	// Add double quotes to field identifiers
			});
			sql = 'INSERT INTO ' + 'dapp_' + config.dappid + '_' + config.table + ' (' + fields.join(',') + ') ';
			var rows = [];
			batchPack.forEach(function (value, rowIndex) {
				var currentRow = batchPack[rowIndex];
				var fields = [];
				for (var i = 0; i &lt; currentRow.length; i++) {
					fields.push(__private.escape(currentRow[i]));
				}
				rows.push('SELECT ' + fields.join(','));
			});
			sql = sql + ' ' + rows.join(' UNION ');
			library.db.none(sql).then(function () {
				return setImmediate(cb);
			}).catch(function (err) {
				library.logger.error(err.stack);
				return setImmediate(cb, 'Sql#query error');
			});
		}, done);
	}
};

// Public methods
/**
 * Creates sql sentences to dapp_ tables based on config param and runs them.
 * @implements {jsonSql.build}
 * @implements {async.eachSeries}
 * @implements {library.db.none}
 * @param {string} dappid
 * @param {Object} config
 * @param {function} cb
 * @return {setImmediateCallback} err message | cb
 */
Sql.prototype.createTables = function (dappid, config, cb) {
	if (!config) {
		return setImmediate(cb, 'Invalid table format');
	}

	var sqles = [];
	for (var i = 0; i &lt; config.length; i++) {
		config[i].table = 'dapp_' + dappid + '_' + config[i].table;
		if (config[i].type === 'table') {
			config[i].type = 'create';
			if (config[i].foreignKeys) {
				for (var n = 0; n &lt; config[i].foreignKeys.length; n++) {
					config[i].foreignKeys[n].table = 'dapp_' + dappid + '_' + config[i].foreignKeys[n].table;
				}
			}
		} else if (config[i].type === 'index') {
			config[i].type = 'index';
		} else {
			return setImmediate(cb, 'Unknown table type: ' + config[i].type);
		}

		var sql = jsonSql.build(config[i]);
		sqles.push(sql.query);
	}

	async.eachSeries(sqles, function (command, cb) {
		library.db.none(command).then(function () {
			return setImmediate(cb);
		}).catch(function (err) {
			return setImmediate(cb, err);
		});
	}, function (err) {
		if (err) {
			return setImmediate(cb, 'Sql#createTables error', self);
		} else {
			return setImmediate(cb);
		}
	});
};

/**
 * Drops tables based on config param.
 * @implements {async.eachSeries}
 * @implements {library.db.none}
 * @param {string} dappid
 * @param {Object} config
 * @param {function} cb
 * @return {setImmediateCallback} err message | cb
 */
Sql.prototype.dropTables = function (dappid, config, cb) {
	var tables = [];
	for (var i = 0; i &lt; config.length; i++) {
		tables.push({name: config[i].table.replace(/[^\w_]/gi, ''), type: config[i].type});
	}

	async.eachSeries(tables, function (table, cb) {
		if (table.type === 'create') {
			library.db.none('DROP TABLE IF EXISTS ' + table.name + ' CASCADE').then(function () {
				return setImmediate(cb, null);
			}).catch(function (err) {
				library.logger.error(err.stack);
				return setImmediate(cb, 'Sql#dropTables error');
			});
		} else if (table.type === 'index') {
			library.db.none('DROP INDEX IF EXISTS ' + table.name).then(function () {
				return setImmediate(cb, null);
			}).catch(function (err) {
				library.logger.error(err.stack);
				return setImmediate(cb, 'Sql#dropTables error');
			});
		} else {
			return setImmediate(cb);
		}
	}, cb);
};

/**
 * Calls helpers.sandbox.callMethod().
 * @implements module:helpers#callMethod
 * @param {function} call - Method to call.
 * @param {*} args - List of arguments.
 * @param {function} cb - Callback function.
 */
Sql.prototype.sandboxApi = function (call, args, cb) {
	sandboxHelper.callMethod(shared, call, args, cb);
};

// Events
/**
 * Assigns scope to modules variable.
 * @param {scope} scope - Loaded modules.
 */
Sql.prototype.onBind = function (scope) {
	modules = scope;
};

/**
 * Sets to true private variable loaded.
 */
Sql.prototype.onBlockchainReady = function () {
	__private.loaded = true;
};

// Shared API
/**
 * @implements {__private.query.call}
 * @param {Object} req
 * @param {function} cb
 */
shared.select = function (req, cb) {
	var config = extend({}, req.body, {dappid: req.dappid});
	__private.query.call(this, 'select', config, cb);
};

/**
 * @implements {__private.query.call}
 * @param {Object} req
 * @param {function} cb
 */
shared.batch = function (req, cb) {
	var config = extend({}, req.body, {dappid: req.dappid});
	__private.query.call(this, 'batch', config, cb);
};

/**
 * @implements {__private.query.call}
 * @param {Object} req
 * @param {function} cb
 */
shared.insert = function (req, cb) {
	var config = extend({}, req.body, {dappid: req.dappid});
	__private.query.call(this, 'insert', config, cb);
};

/**
 * @implements {__private.query.call}
 * @param {Object} req
 * @param {function} cb
 */
shared.update = function (req, cb) {
	var config = extend({}, req.body, {dappid: req.dappid});
	__private.query.call(this, 'update', config, cb);
};

/**
 * @implements {__private.query.call}
 * @param {Object} req
 * @param {function} cb
 */
shared.remove = function (req, cb) {
	var config = extend({}, req.body, {dappid: req.dappid});
	__private.query.call(this, 'remove', config, cb);
};

// Export
module.exports = Sql;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-accounts.html">accounts</a></li><li><a href="module-app.html">app</a></li><li><a href="module-blocks.html">blocks</a></li><li><a href="module-dapps.html">dapps</a></li><li><a href="module-delegates.html">delegates</a></li><li><a href="module-helpers.html">helpers</a></li><li><a href="module-helpers.module_helpers_diff.html">helpers/diff</a></li><li><a href="module-helpers.module_helpers_httpApi.html">helpers/httpApi</a></li><li><a href="module-helpers.module_helpers_slots.html">helpers/slots</a></li><li><a href="module-loader.html">loader</a></li><li><a href="module-multisignatures.html">multisignatures</a></li><li><a href="module-peers.html">peers</a></li><li><a href="module-rounds.html">rounds</a></li><li><a href="module-server.html">server</a></li><li><a href="module-signatures.html">signatures</a></li><li><a href="module-transactions.html">transactions</a></li><li><a href="module-transport.html">transport</a></li></ul><h3>Classes</h3><ul><li><a href="Crypto.html">Crypto</a></li><li><a href="Field.html">Field</a></li><li><a href="Migrator.html">Migrator</a></li><li><a href="module-accounts.Account.html">Account</a></li><li><a href="module-accounts.Accounts.html">Accounts</a></li><li><a href="module-accounts.AccountsHttpApi.html">AccountsHttpApi</a></li><li><a href="module-blocks.Block.html">Block</a></li><li><a href="module-blocks.BlockReward.html">BlockReward</a></li><li><a href="module-blocks.Blocks.html">Blocks</a></li><li><a href="module-blocks.BlocksHttpApi.html">BlocksHttpApi</a></li><li><a href="module-dapps.DApp.html">DApp</a></li><li><a href="module-dapps.DApps.html">DApps</a></li><li><a href="module-dapps.DappsHttpApi.html">DappsHttpApi</a></li><li><a href="module-dapps.InTransfer.html">InTransfer</a></li><li><a href="module-dapps.OutTransfer.html">OutTransfer</a></li><li><a href="module-delegates.Delegate.html">Delegate</a></li><li><a href="module-delegates.Delegates.html">Delegates</a></li><li><a href="module-delegates.DelegatesHttpApi.html">DelegatesHttpApi</a></li><li><a href="module-helpers.BigNumber.html">BigNumber</a></li><li><a href="module-helpers.Inserts.html">Inserts</a></li><li><a href="module-helpers.RoundChanges.html">RoundChanges</a></li><li><a href="module-helpers.Sequence.html">Sequence</a></li><li><a href="module-helpers.Validator.html">Validator</a></li><li><a href="module-helpers.z_schema.html">z_schema</a></li><li><a href="module-loader.Loader.html">Loader</a></li><li><a href="module-loader.LoaderHttpApi.html">LoaderHttpApi</a></li><li><a href="module-multisignatures.Multisignature.html">Multisignature</a></li><li><a href="module-multisignatures.Multisignatures.html">Multisignatures</a></li><li><a href="module-multisignatures.MultisignaturesHttpApi.html">MultisignaturesHttpApi</a></li><li><a href="module-peers.Peer.html">Peer</a></li><li><a href="module-peers.Peers.html">Peers</a></li><li><a href="module-peers.PeersHttpApi.html">PeersHttpApi</a></li><li><a href="module-rounds.Round.html">Round</a></li><li><a href="module-rounds.Rounds.html">Rounds</a></li><li><a href="module-server.Server.html">Server</a></li><li><a href="module-server.ServerHttpApi.html">ServerHttpApi</a></li><li><a href="module-signatures.Signature.html">Signature</a></li><li><a href="module-signatures.Signatures.html">Signatures</a></li><li><a href="module-signatures.SignaturesHttpApi.html">SignaturesHttpApi</a></li><li><a href="module-transactions.Transaction.html">Transaction</a></li><li><a href="module-transactions.TransactionPool.html">TransactionPool</a></li><li><a href="module-transactions.Transactions.html">Transactions</a></li><li><a href="module-transactions.TransactionsHttpApi.html">TransactionsHttpApi</a></li><li><a href="module-transactions.Transfer.html">Transfer</a></li><li><a href="module-transport.Broadcaster.html">Broadcaster</a></li><li><a href="module-transport.Transport.html">Transport</a></li><li><a href="module-transport.TransportHttpApi.html">TransportHttpApi</a></li><li><a href="Sql.html">Sql</a></li><li><a href="System.html">System</a></li><li><a href="Vote.html">Vote</a></li></ul><h3>Events</h3><ul><li><a href="module-app.html#~event:cleanup">cleanup</a></li><li><a href="module-app.html#~event:exit">exit</a></li><li><a href="module-app.html#~event:SIGINT">SIGINT</a></li><li><a href="module-app.html#~event:SIGTERM">SIGTERM</a></li><li><a href="module-app.html#~event:uncaughtException">uncaughtException</a></li></ul><h3>Namespaces</h3><ul><li><a href="-__private.html">__private</a></li><li><a href="module-helpers.constants.html">constants</a></li><li><a href="module-helpers.ed.html">ed</a></li><li><a href="module-helpers.exceptions.html">exceptions</a></li><li><a href="module-helpers.module_helpers_httpApi-middleware.html">middleware</a></li><li><a href="module-helpers.module_helpers_slots.html">helpers/slots</a></li></ul><h3>Global</h3><ul><li><a href="global.html#afterSave">afterSave</a></li><li><a href="global.html#aggregateBlocksReward">aggregateBlocksReward</a></li><li><a href="global.html#applyBlock">applyBlock</a></li><li><a href="global.html#applyGenesisBlock">applyGenesisBlock</a></li><li><a href="global.html#applyLimits">applyLimits</a></li><li><a href="global.html#applyTransaction">applyTransaction</a></li><li><a href="global.html#checkTransaction">checkTransaction</a></li><li><a href="global.html#count">count</a></li><li><a href="global.html#deleteAfterBlock">deleteAfterBlock</a></li><li><a href="global.html#deleteBlock">deleteBlock</a></li><li><a href="global.html#deleteLastBlock">deleteLastBlock</a></li><li><a href="global.html#generateBlock">generateBlock</a></li><li><a href="global.html#getBlockProgressLogger">getBlockProgressLogger</a></li><li><a href="global.html#getById">getById</a></li><li><a href="global.html#getCommonBlock">getCommonBlock</a></li><li><a href="global.html#getIdSequence">getIdSequence</a></li><li><a href="global.html#getLastBlock">getLastBlock</a></li><li><a href="global.html#isLoaded">isLoaded</a></li><li><a href="global.html#lastReceipt">lastReceipt</a></li><li><a href="global.html#list">list</a></li><li><a href="global.html#loadBlocksData">loadBlocksData</a></li><li><a href="global.html#loadBlocksFromPeer">loadBlocksFromPeer</a></li><li><a href="global.html#loadBlocksOffset">loadBlocksOffset</a></li><li><a href="global.html#loadBlocksPart">loadBlocksPart</a></li><li><a href="global.html#loadLastBlock">loadLastBlock</a></li><li><a href="global.html#onBind">onBind</a></li><li><a href="global.html#onReceiveBlock">onReceiveBlock</a></li><li><a href="global.html#popLastBlock">popLastBlock</a></li><li><a href="global.html#processBlock">processBlock</a></li><li><a href="global.html#promiseTransactions">promiseTransactions</a></li><li><a href="global.html#readDbRows">readDbRows</a></li><li><a href="global.html#receiveBlock">receiveBlock</a></li><li><a href="global.html#recoverChain">recoverChain</a></li><li><a href="global.html#sandboxApi">sandboxApi</a></li><li><a href="global.html#saveBlock">saveBlock</a></li><li><a href="global.html#saveGenesisBlock">saveGenesisBlock</a></li><li><a href="global.html#shared">shared</a></li><li><a href="global.html#validateForce">validateForce</a></li><li><a href="global.html#verifyBlock">verifyBlock</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Thu May 11 2017 11:47:30 GMT-0300 (ART)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
